# V7.2.3 Fix Deck ID Mapping - Task Checklist

**Goal**: Map the URL `/decks/[id]` to the correct `deck_template_id` so `bulkCreateMCQV2` can save cards successfully.

## Root Cause Analysis

### Step 1 – Discover What `4e11747b-e30d-460b-87b3-66f1c6cd3ead` Actually Is

- [x] 1.1 Inspect Supabase tables

**Findings:**

| Table | ID Found? | Notes |
|-------|-----------|-------|
| `deck_templates` | ❌ No | V2 schema - stores template definitions |
| `user_decks` | ❌ No | V2 schema - links users to templates |
| `decks` | ✅ **YES** | Legacy V1 table - this is where the ID exists |

**The Problem:**
- The URL `/decks/4e11747b.../add-bulk` uses an ID from the **legacy `decks` table**
- `bulkCreateMCQV2` only checks `deck_templates` and `user_decks` (V2 schema)
- The fallback never checks the legacy `decks` table, causing `NOT_FOUND`

## Solution Implemented

### Step 2 – Add Legacy Decks Fallback to bulkCreateMCQV2

- [x] 2.1 Add third fallback to check legacy `decks` table
  - After `user_decks` fallback fails, check `decks` table
  - If found and user owns it, auto-migrate to V2 schema:
    1. Create new `deck_template` with same title
    2. Create `user_deck` linking user to new template
    3. Use new template ID for card creation

- [x] 2.2 Add deep logging for legacy decks fallback
  - `[bulkCreateMCQV2] Legacy decks lookup result`
  - `[bulkCreateMCQV2] Auto-migrating legacy deck to V2 schema...`
  - `[bulkCreateMCQV2] Successfully migrated legacy deck to V2`

### Step 3 – Verify Fix

- [ ] 3.1 Test Manual Scan Page flow
  - Upload PDF, click Scan Page, save cards
  - Verify console shows successful migration and card creation
  - _Expected: `[bulkCreateMCQV2] Successfully migrated legacy deck to V2`_

- [ ] 3.2 Test Auto-Scan flow
  - Start Auto-Scan, let it process a few pages
  - Verify cards are saved successfully
  - _Expected: No more `NOT_FOUND` errors_

---

## ID Resolution Flow (Updated)

```
bulkCreateMCQV2 receives ID
        │
        ▼
┌─────────────────────────────┐
│ 1. Check deck_templates     │
│    by id                    │
└─────────────────────────────┘
        │ Not found?
        ▼
┌─────────────────────────────┐
│ 2. Check user_decks         │
│    by id → get template_id  │
└─────────────────────────────┘
        │ Not found?
        ▼
┌─────────────────────────────┐
│ 3. Check legacy decks       │  ← NEW in V7.2.3
│    by id → auto-migrate     │
│    to V2 schema             │
└─────────────────────────────┘
        │ Not found?
        ▼
┌─────────────────────────────┐
│ 4. Return NOT_FOUND error   │
└─────────────────────────────┘
```

## Files Modified

- `src/actions/batch-mcq-actions.ts` - Added legacy decks fallback with auto-migration

## Notes

- The auto-migration creates a new `deck_template` each time a legacy deck is used
- This is a one-time migration per legacy deck
- Future saves will use the newly created `deck_template_id`
- No changes to UI or hooks required - fix is entirely server-side
