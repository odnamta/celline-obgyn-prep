# V7.2.5 The 'Ghost Data' Fix

**Goal**: Fix the Deck Details page to show cards from migrated V2 decks.

## Root Cause

1. **Ghost Data**: Cards saved via Auto-Scan go to `card_templates` (V2), but the deck page fetches from `cards` (V1)
2. **Duplicate Migrations**: Each save was creating a new `deck_template` because `legacy_id` wasn't being set or checked

## Fixes Applied

### Fix 1: Show Migrated Cards (Critical)

- [x] Updated `src/app/(app)/decks/[deckId]/page.tsx`
- [x] Logic:
  1. Check if `deck_templates` has a row with `legacy_id = deckId`
  2. If found, fetch cards from `card_templates` instead of `cards`
  3. Map V2 card_templates to legacy Card format for CardList compatibility

### Fix 2: Prevent Duplicate Migrations

- [x] Updated `src/actions/batch-mcq-actions.ts`
- [x] Logic:
  1. Before creating new deck_template, check if one already exists with `legacy_id = legacyDeck.id`
  2. If found, reuse it instead of creating a new one
  3. When creating new, set `legacy_id` to link back to original deck

## Code Changes

### Deck Details Page
```typescript
// V7.2.5: Check if this legacy deck has been migrated to V2
const { data: migratedTemplate } = await supabase
  .from('deck_templates')
  .select('id')
  .eq('legacy_id', deckId)
  .single()

if (migratedTemplate) {
  // Fetch V2 cards from card_templates
  const { data: v2Cards } = await supabase
    .from('card_templates')
    .select('id, stem, options, correct_index, explanation, created_at')
    .eq('deck_template_id', migratedTemplate.id)
    .order('created_at', { ascending: false })
  // Map to legacy Card format...
} else {
  // Fetch legacy cards from cards table
}
```

### Migration Logic
```typescript
// V7.2.5: First check if this legacy deck was already migrated
const { data: existingMigrated } = await supabase
  .from('deck_templates')
  .select('id, author_id')
  .eq('legacy_id', legacyDeck.id)
  .single()

if (existingMigrated) {
  // Reuse existing migrated template
  deckTemplateId = existingMigrated.id
} else {
  // Create new with legacy_id set
  const { data: newTemplate } = await supabase
    .from('deck_templates')
    .insert({
      title: legacyDeck.title,
      author_id: user.id,
      visibility: 'private',
      legacy_id: legacyDeck.id,  // Link back to original
    })
}
```

## Verification

- [ ] Navigate to `/decks/4e11747b.../` - should now show V2 cards
- [ ] Run Auto-Scan again - should reuse existing migrated template
- [ ] Check database - no more duplicate deck_templates for same legacy deck

## Files Modified

- `src/app/(app)/decks/[deckId]/page.tsx` - Added V2 card fetching
- `src/actions/batch-mcq-actions.ts` - Added legacy_id check and set
