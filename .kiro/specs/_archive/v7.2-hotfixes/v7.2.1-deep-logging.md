# V7.2.1 Deep Logging Patch - Task Checklist

**Goal**: Add detailed logging around `bulkCreateMCQV2` and its callers to debug `NOT_FOUND` errors.

## Step 1 – Locate bulkCreateMCQV2

- [x] 1.1 Find the server action
  - Located in `src/actions/batch-mcq-actions.ts`
  - Added comment: `// NOTE: Deep logging added in V7.2.1 – used to debug deckTemplateId issues.`

## Step 2 – Add Deep Logs Inside bulkCreateMCQV2

- [x] 2.1 Raw Input + Deck Lookups
  - Added `[bulkCreateMCQV2] RAW INPUT` log at function entry
  - Added `[bulkCreateMCQV2] deck_templates lookup` log before first DB call
  - Added `[bulkCreateMCQV2] deck_templates lookup result` log after lookup

- [x] 2.2 Smart Fallback Logging
  - Added `[bulkCreateMCQV2] Fallback: treating ID as user_deck_id` warning log
  - Added `[bulkCreateMCQV2] Resolved deck_template lookup result` log after fallback
  - Added `[bulkCreateMCQV2] FINAL FAILURE` error log when both lookups fail
  - Error message includes original ID: `Deck template not found for id=${originalDeckTemplateId}`

## Step 3 – Log Callers (Manual Scan & Auto-Scan)

- [x] 3.1 BatchReviewPanel (Manual Save)
  - Added `[BatchReviewPanel] Saving via bulkCreateMCQV2` log in `src/components/batch/BatchReviewPanel.tsx`
  - Logs: `deckTemplateId`, `sessionTags`, `cardsCount`

- [x] 3.2 useAutoScan (Auto-Scan Save)
  - Added `[AutoScan] Calling bulkCreateMCQV2` log in `src/hooks/use-auto-scan.ts`
  - Logs: `deckTemplateId`, `page`, `cardsCount`

## Step 4 – Sanity Checks

- [x] 4.1 Type Safety & Build
  - TypeScript diagnostics: ✅ No errors
  - No business logic changes – only logging added

---

## How to Read the Logs

### Where Logs Appear

- **Server-side logs** (`[bulkCreateMCQV2]`): Appear in your terminal running `npm run dev` or in Vercel/deployment logs
- **Client-side logs** (`[BatchReviewPanel]`, `[AutoScan]`): Appear in browser DevTools Console (F12)

### Log Flow for Manual Scan Page

```
1. [BatchReviewPanel] Saving via bulkCreateMCQV2
   → Shows: deckTemplateId, sessionTags, cardsCount
   
2. [bulkCreateMCQV2] RAW INPUT
   → Shows: deckTemplateId, cardsCount, sessionTagsCount
   
3. [bulkCreateMCQV2] deck_templates lookup
   → Shows: requestedId
   
4. [bulkCreateMCQV2] deck_templates lookup result
   → Shows: found (true/false), error, errorCode
   
5a. If found → proceeds to create cards
5b. If NOT found → fallback logs appear:
    - [bulkCreateMCQV2] Fallback: treating ID as user_deck_id
    - [bulkCreateMCQV2] Legacy UserDeckID passed; resolved (if successful)
    - [bulkCreateMCQV2] FINAL FAILURE (if both lookups fail)
```

### Log Flow for Auto-Scan

```
1. [AutoScan] Calling bulkCreateMCQV2
   → Shows: deckTemplateId, page, cardsCount
   
2-5. Same as Manual Scan Page (server-side logs)
```

### Debugging NOT_FOUND Errors

When you see `NOT_FOUND`, check:

1. **RAW INPUT** - What ID was passed?
2. **deck_templates lookup result** - Did it find a row? What error?
3. **Fallback log** - Did it try user_decks? What was found?
4. **FINAL FAILURE** - Shows both original and attempted IDs

Common issues:
- `deckTemplateId` is actually a `user_deck_id` (fallback should handle this)
- `deckTemplateId` is undefined/null (check caller logs)
- ID doesn't exist in either table (data issue)
